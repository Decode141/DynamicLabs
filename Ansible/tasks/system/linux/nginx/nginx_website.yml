---
# Installs nginx with a default website supporting php and mysql
#
# name - website name
# 
#
# Example 1:
#            {
#                name = "Linux_Nginx_Website"
#                value = [
#                    { name = "www.example.com"}
#                    ]
#
#            }
# Example 2:
#            {
#                name = "Linux_Nginx_Website"
#                value = [
#                    { name = "www.example.com", port = "8080" }
#                    ]
#            }
#
# Example 3:
#                name = "Linux_Dirtree_Copy"
#                value = [
#                    { # Copy Webroot
#                        path = "/var/www/www.example.com/", 
#                        asset = "example_website/" # Specifying a / at the end will copy just the contents and not the directory itself
#                        owner = "root" 
#                    }
#               ]
#            {
#                name = "Linux_Nginx_Website"
#                value = [
#                    { name = "www.example.com", webroot = "/var/www/www.example.com" }
#                    ]
#            }

- name: Install Nginx
  apt:
    pkg:
    - nginx
    - php
    - php-fpm
    - php-mysql
    update_cache: yes

- copy:
    dest: "/etc/nginx/sites-enabled/default"
    content: |
      # You should look at the following URL's in order to grasp a solid understanding
      # of Nginx configuration files in order to fully unleash the power of Nginx.
      # https://www.nginx.com/resources/wiki/start/
      # https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/
      # https://wiki.debian.org/Nginx/DirectoryStructure
      #
      # In most cases, administrators will remove this file from sites-enabled/ and
      # leave it as reference inside of sites-available where it will continue to be
      # updated by the nginx packaging team.
      #
      # This file will automatically load configuration files provided by other
      # applications, such as Drupal or Wordpress. These applications will be made
      # available underneath a path with that package name, such as /drupal8.
      #
      # Please see /usr/share/doc/nginx-doc/examples/ for more detailed examples.
      ##

      # Default server configuration
      #
      server {
      	listen {{ item.port | default('80') }} default_server;
      	listen [::]:{{ item.port | default('80') }} default_server;

      	# SSL configuration
      	#
      	# listen 443 ssl default_server;
      	# listen [::]:443 ssl default_server;
      	#
      	# Note: You should disable gzip for SSL traffic.
      	# See: https://bugs.debian.org/773332
      	#
      	# Read up on ssl_ciphers to ensure a secure configuration.
      	# See: https://bugs.debian.org/765782
      	#
      	# Self signed certs generated by the ssl-cert package
      	# Don't use them in a production server!
      	#
      	# include snippets/snakeoil.conf;

      	root {{ item.webroot | default('/var/www/html') }};

      	# Add index.php to the list if you are using PHP
      	index index.html index.htm index.nginx-debian.html;

      	server_name {{ item.name }};

      	location / {
      		# First attempt to serve request as file, then
      		# as directory, then fall back to displaying a 404.
      		try_files $uri $uri/ =404;
      	}

      	# pass PHP scripts to FastCGI server
      	#
      	location ~ \.php$ {
      		include snippets/fastcgi-php.conf;

      		# With php-fpm (or other unix sockets):
      		fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
      	#	# With php-cgi (or other tcp sockets):
      	#	fastcgi_pass 127.0.0.1:9000;
      	}

      	# deny access to .htaccess files, if Apache's document root
      	# concurs with nginx's one
      	#
      	#location ~ /\.ht {
      	#	deny all;
      	#}
      }
    owner: root

# Apache is installed as a dependency of php-fpm.
# Disable it
- name: Disable Apache2
  service:
    name: apache2
    state: stopped
    enabled: false

- name: Reload nginx configuration
  service:
    name: nginx
    state: reloaded
    enabled: true

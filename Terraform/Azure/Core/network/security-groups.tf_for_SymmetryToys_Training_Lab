#
# Customised security groups for the SymmetryToys training lab.
# This needs to be completely rewritten as it's a bit messy :(
# 


resource "azurerm_network_security_group" "sg0" {
    name                = "${terraform.workspace}-SG-Management"
    resource_group_name = var.resource_group_name
    location            = var.location

    security_rule {
        name                       = "AllowSSH"
        priority                   = 100
        direction                  = "Inbound"
        access                     = "Allow"
        protocol                   = "Tcp"
        source_port_range          = "*"
        destination_port_range     = "22"
        source_address_prefixes    = var.attacker_ip
        destination_address_prefix = "*"
    }

    security_rule {
        name                       = "AllowWeb"
        priority                   = 101
        direction                  = "Inbound"
        access                     = "Allow"
        protocol                   = "Tcp"
        source_port_range          = "*"
        destination_port_range     = "10000"
        source_address_prefixes    = var.address_space
        destination_address_prefix = "*"
    }

    security_rule {
        name                       = "AllowOutbound"
        priority                   = 1000
        direction                  = "Outbound"
        access                     = "Allow"
        protocol                   = "*"
        source_port_range          = "*"
        destination_port_range     = "*"
        source_address_prefixes    = var.address_space
        destination_address_prefix = "*"
    }

}

resource "azurerm_network_security_group" "sg1" {
    name                = "${terraform.workspace}-SG-Internal"
    resource_group_name = var.resource_group_name
    location            = var.location

    security_rule {
        name                       = "AllowAnyInternal"
        priority                   = 100
        direction                  = "Inbound"
        access                     = "Allow"
        protocol                   = "*"
        source_port_range          = "*"
        destination_port_range     = "*"
#        source_address_prefixes    = var.address_space
        source_address_prefixes    = [ "10.2.54.0/24" ]
        destination_address_prefix = "*"
    }

    security_rule {
        name                       = "AllowManagement"
        priority                   = 101
        direction                  = "Inbound"
        access                     = "Allow"
        protocol                   = "*"
        source_port_range          = "*"
        destination_port_range     = "*"
        # source_address_prefixes    = var.address_space
        source_address_prefixes    = [ "10.1.254.0/24" ]
        destination_address_prefix = "*"
    }


    security_rule {
        name                       = "AllowOutbound"
        priority                   = 1000
        direction                  = "Outbound"
        access                     = "Allow"
        protocol                   = "*"
        source_port_range          = "*"
        destination_port_range     = "*"
        source_address_prefixes    = var.address_space
        destination_address_prefix = "*"
    }
}

resource "azurerm_network_security_group" "sg2" {
    name                = "${terraform.workspace}-SG-External"
    resource_group_name = var.resource_group_name
    location            = var.location

    security_rule {
        name                       = "AllowAnyInternal"
        priority                   = 100
        direction                  = "Inbound"
        access                     = "Allow"
        protocol                   = "*"
        source_port_range          = "*"
        destination_port_range     = "*"
        # source_address_prefixes    = var.address_space
        source_address_prefixes    = [ "10.2.99.0/24" ]
        destination_address_prefix = "*"
    }

    security_rule {
        name                       = "AllowManagement"
        priority                   = 101
        direction                  = "Inbound"
        access                     = "Allow"
        protocol                   = "*"
        source_port_range          = "*"
        destination_port_range     = "*"
        # source_address_prefixes    = var.address_space
        source_address_prefixes    = [ "10.1.254.0/24" ]
        destination_address_prefix = "*"
    }

#    security_rule {
#        name                       = "AllowInternetRDP"
#        priority                   = 102
#        direction                  = "Inbound"
#        access                     = "Allow"
#        protocol                   = "Tcp"
#        source_port_range          = "*"
#        destination_port_range     = "3389"
#        source_address_prefixes    = var.attacker_ip
#        destination_address_prefix = "*"
#    }

#    security_rule {
#        name                       = "AllowInternetSSH"
#        priority                   = 103
#        direction                  = "Inbound"
#        access                     = "Allow"
#        protocol                   = "Tcp"
#        source_port_range          = "*"
#        destination_port_range     = "22"
#        source_address_prefixes    = var.attacker_ip
#        destination_address_prefix = "*"
#    }

    # Access to PUBWEB01 web server
    security_rule {
        name                       = "AllowPubweb01"
        priority                   = 104
        direction                  = "Inbound"
        access                     = "Allow"
        protocol                   = "Tcp"
        source_port_range          = "*"
        destination_port_range     = "80"
        source_address_prefixes    = [ "10.10.10.0/24" ]
        destination_address_prefix = "10.2.99.12"
    }

    # Access to CUSTOMERWEB01 web server 
    security_rule {
        name                       = "AllowCustomerweb01"
        priority                   = 105
        direction                  = "Inbound"
        access                     = "Allow"
        protocol                   = "Tcp"
        source_port_range          = "*"
        destination_port_range     = "80"
        source_address_prefixes    = [ "10.10.10.0/24" ]
        destination_address_prefix = "10.2.99.11"
    }

    security_rule {
        name                       = "AllowDCCORP"
        priority                   = 106
        direction                  = "Outbound"
        access                     = "Allow"
        protocol                   = "*"
        source_port_range          = "*"
        destination_port_range     = "*"
        source_address_prefixes    = [ "10.2.99.0/24" ]
        destination_address_prefix = "10.2.54.4"
    }

    security_rule {
        name                       = "AllowDCPARADOX"
        priority                   = 107
        direction                  = "Outbound"
        access                     = "Allow"
        protocol                   = "*"
        source_port_range          = "*"
        destination_port_range     = "*"
        source_address_prefixes    = [ "10.2.99.0/24" ]
        destination_address_prefix = "10.2.54.6"
    }

    security_rule {
        name                       = "AllowJMPBOX"
        priority                   = 108
        direction                  = "Outbound"
        access                     = "Allow"
        protocol                   = "*"
        source_port_range          = "*"
        destination_port_range     = "*"
        source_address_prefixes    = [ "10.2.99.0/24" ]
        destination_address_prefix = "10.2.54.7"
    }

    security_rule {
        name                       = "DenyInternalNetworks1"
        priority                   = 500
        direction                  = "Outbound"
        access                     = "Deny"
        protocol                   = "*"
        source_port_range          = "*"
        destination_port_range     = "*"
        source_address_prefixes    = [ "10.2.99.0/24" ]
        destination_address_prefix = "10.2.54.0/24"
    }

    security_rule {
        name                       = "DenyInternalNetworks2"
        priority                   = 501
        direction                  = "Outbound"
        access                     = "Deny"
        protocol                   = "*"
        source_port_range          = "*"
        destination_port_range     = "*"
        source_address_prefixes    = [ "10.2.99.0/24" ]
        destination_address_prefix = "10.2.2.0/24"
    }

    security_rule {
        name                       = "AllowOutbound"
        priority                   = 1000
        direction                  = "Outbound"
        access                     = "Allow"
        protocol                   = "*"
        source_port_range          = "*"
        destination_port_range     = "*"
        source_address_prefixes    = [ "10.2.99.0/24" ]
        destination_address_prefix = "Internet"
    }
}

resource "azurerm_network_security_group" "sg3" {
    name                = "${terraform.workspace}-SG-Attacker"
    resource_group_name = var.resource_group_name
    location            = var.location

    security_rule {
        name                       = "AllowAnyInternal"
        priority                   = 100
        direction                  = "Inbound"
        access                     = "Allow"
        protocol                   = "*"
        source_port_range          = "*"
        destination_port_range     = "*"
        source_address_prefixes    = var.address_space
        destination_address_prefix = "*"
    }
    
    security_rule {
        name                       = "AllowInternetSSH"
        priority                   = 103
        direction                  = "Inbound"
        access                     = "Allow"
        protocol                   = "Tcp"
        source_port_range          = "*"
        destination_port_range     = "22"
        source_address_prefixes    = var.attacker_ip
        destination_address_prefix = "*"
    }

#    security_rule {
#        name                       = "AllowOutbound"
#        priority                   = 1000
#        direction                  = "Outbound"
#        access                     = "Allow"
#        protocol                   = "*"
#        source_port_range          = "*"
#        destination_port_range     = "*"
#        source_address_prefixes    = var.address_space
#        destination_address_prefix = "Internet"
#    }

    # Access to PUBWEB01 web server
    security_rule {
        name                       = "AllowPubweb01"
        priority                   = 104
        direction                  = "Outbound"
        access                     = "Allow"
        protocol                   = "Tcp"
        source_port_range          = "*"
        destination_port_range     = "80"
        source_address_prefixes    = [ "10.10.10.0/24" ]
        destination_address_prefix = "10.2.99.12"
    }

    # Access to CUSTOMERWEB01 web server 
    security_rule {
        name                       = "AllowCustomerweb01"
        priority                   = 105
        direction                  = "Outbound"
        access                     = "Allow"
        protocol                   = "Tcp"
        source_port_range          = "*"
        destination_port_range     = "80"
        source_address_prefixes    = [ "10.10.10.0/24" ]
        destination_address_prefix = "10.2.99.11"
    }

    security_rule {
        name                       = "DenyInternalNetworks"
        priority                   = 1000
        direction                  = "Outbound"
        access                     = "Deny"
        protocol                   = "*"
        source_port_range          = "*"
        destination_port_range     = "*"
        source_address_prefixes    = [ "10.10.10.0/24" ]
        destination_address_prefix = "10.2.0.0/16"
    }


}

resource "azurerm_network_security_group" "sg4" {
    name                = "${terraform.workspace}-SG-Internal2"
    resource_group_name = var.resource_group_name
    location            = var.location

    security_rule {
        name                       = "AllowAnyInternal"
        priority                   = 100
        direction                  = "Inbound"
        access                     = "Allow"
        protocol                   = "*"
        source_port_range          = "*"
        destination_port_range     = "*"
        source_address_prefixes    = [ "10.2.2.0/24" ]
        destination_address_prefix = "*"
    }

    security_rule {
        name                       = "AllowManagement"
        priority                   = 101
        direction                  = "Inbound"
        access                     = "Allow"
        protocol                   = "*"
        source_port_range          = "*"
        destination_port_range     = "*"
        # source_address_prefixes    = var.address_space
        source_address_prefixes    = [ "10.1.254.0/24" ]
        destination_address_prefix = "*"
    }

    security_rule {
        name                       = "AllowOutbound"
        priority                   = 1000
        direction                  = "Outbound"
        access                     = "Allow"
        protocol                   = "*"
        source_port_range          = "*"
        destination_port_range     = "*"
        source_address_prefixes    = var.address_space
        destination_address_prefix = "Internet"
    }

}